{% extends "_base.html" %}
{% load i18n %}

{% block title %}
    {# Translators: Page title. #}
    {# Translators: تایتڵی پەڕە. #}
{{ writer.name }}
{% endblock title %}


{% block content %}
<!-- breadcrumb -->
<ul class="breadcrumb">
    {# Translators: Breadcrumb link. #}
    {# Translators: لینکی برید کرەمب. #}
    <li class="breadcrumb-item"><a href="{% url 'home' %}">{% trans 'Home' %}</a></li>
    {# Translators: Breadcrumb link. #}
    {# Translators: لینکی برید کرەمب. #}
    <li class="breadcrumb-item"><a href="{% url 'library' %}">{% trans 'Library' %}</a></li>
    {# Translators: Breadcrumb link. #}
    {# Translators: لینکی برید کرەمب. #}
    <li class="breadcrumb-item active">{{ book.name }}</li>
</ul>

<h1>{% trans 'Book' %}:</h1>
<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#detail">{% trans 'Detail' %}</a>
    </li>
    <li id="history_tab" class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#history">{% trans "History" %}</a>
    </li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
    <div id="detail" class="tab-pane active">
        <article class="media content-section">
            {% load thumbnail %}
            {% thumbnail book.image "125x125" crop="center" as im %}
            <!-- link to Open the Modal -->
            <a role="button" data-toggle="modal" data-target="#book{{ book.id }}">
                <img class="rounded-circle article-img" src="{{im.url}}">
            </a>
            {% endthumbnail %}
            <div class="media-body">
                <div class="article-metadata">
                    {% trans "Created by" %}:
                    <a class="mr-2" href="#">{{ book.creator.first_name }} {{book.creator.last_name}}</a>
                    {# Translators: For determine date. #}
                    {# Translators: بۆ دیاریکردنی بەروار (لە). #}
                    <small class="text-muted">{% trans 'in' %} {{ book.timestamp|date:"d/m/Y - H:i:s" }}</small>
                    <a class="btn btn-outline-secondary btn-sm mt-1 mb-1" href="{% url 'book-update' book.id %}">{% trans "Update" %}</a>
                    <a class="btn btn-outline-danger btn-sm mt-1 mb-1 float-right" href="#">{% trans "Report" %}</a>
                </div>
                <h2 class="article-title">{{ book.name }}</h2>
                <small class="text-muted">{% trans "Writer" %}: {{ book.writer }} (book.job)</small>
                <br>
                <small class="text-muted">{% trans "Location" %}: {{ book.location }}</small>
                <br>
                <small class="text-muted">{% trans "Publisher" %}: {{ book.publisher }}</small>
                <br>
                <small class="text-muted">{% trans "Genre" %}: {{ book.genre }}</small>
                <br>
                <small class="text-muted">{% trans "Language" %}: {{ book.language }}</small>
                <br>
                <small class="text-muted">{% trans "Year" %}: {{ book.year|date:"Y"}}</small>
                <br>
                <small class="text-muted">{% trans "Edition Number" %}: {{ book.edition_number }}</small>
                <br>
                <small class="text-muted">{% trans "Volume" %}: {{ book.volume }}</small>
                <br>
                <small class="text-muted">{% trans "part" %}: {{ book.part }}</small>
                <br>
                <small class="text-muted">{% trans "Page Quantity" %}: {{ book.page_quantity }}</small>
                <br>
                <small class="text-muted">{% trans "Is copyright?" %}: {{ book.is_copyright }}</small>
                <p class="article-content">
                    {% trans "Description" %}:
                    <small class="text-muted">{{ book.description }}</small>
                </p>
            </div>
        </article>
    </div>

    <div id="history" class="tab-pane fade">
        <br>
        <div class="spinner-grow text-muted"></div>
        <div class="spinner-grow text-primary"></div>
        <div class="spinner-grow text-success"></div>
        <div class="spinner-grow text-info"></div>
        <div class="spinner-grow text-warning"></div>
        <div class="spinner-grow text-danger"></div>
        <div class="spinner-grow text-secondary"></div>
        <div class="spinner-grow text-dark"></div>
        <div class="spinner-grow text-light"></div>
    </div>
</div>

<!-- The Modal -->
<div class="modal fade" id="book{{ book.id }}">
    <div class="modal-dialog modal-l">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">{{ book.name }}</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <img src="{{ book.image.url }}" class="rounded img-fluid">
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">{% trans "Close" %}</button>
            </div>
        </div>
    </div>
</div>

<!------------------------------------------------------------->
<!------------------------------------------------------------->
<!------------------------------------------------------------->
<!------------------------------------------------------------->
<!---------------- Page Nav tabs ------------------------------>
<h1>{% trans 'Pages' %}:</h1>

<!-- Nav tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#page_detail">{% trans 'Detail' %}</a>
    </li>
    <li id="page_history_tab" class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#page_history">{% trans "History" %}</a>
    </li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
    <div id="page_detail" class="tab-pane active">
        <article class="media content-section">
            <div class="media-body">
                <p>{% trans 'Page' %}:</p>
                <button onclick="pageFormCancel()">test </button>
                <span class="btn-group">
                    <button id="add-page" type="button" class="btn btn-primary" onclick="addPage()"><i class="bi bi-file-earmark-plus"></i></button>
                    <button id="edit-page" disabled type="button" class="btn btn-primary" onclick="editPage()"><i class="bi bi-pencil-square"></i></button>
                    <button id="up-page" disabled type="button" class="btn btn-primary" onclick="upPage()"><i class="bi bi-arrow-90deg-up"></i></button>
                    <button id="down-page" disabled type="button" class="btn btn-primary" onclick="downPage()"><i class="bi bi-arrow-90deg-down"></i></button>
                    <button id="delete-page" disabled type="button" class="btn btn-primary" onclick="deletePage()"><i class="bi bi-trash"></i></button>
                </span>

                <div class="row">
                    <div id="pageList" class="col-2">
                        <div id="page-list-tab" class="list-group" role="tablist" style="overflow:auto; height: 400px;">
                            <!-- content will come by javascript -->
                        </div>
                    </div>
                    <div class="col-10">

                        <div class="tab-content" id="page-content-tab">
                            <div class="tab-pane fade" id="page-0" role="tabpanel"></div>
                            {% for page in pages %}
                            <div class="tab-pane fade" id="page-{{ page.id }}" role="tabpanel"></div>
                            {% empty %}
                            <p class="article-title">
                                {% trans 'The Book is not have any page yet.' %}</h2>
                                {% endfor %}
                        </div>


                    </div>
                </div>



            </div>
        </article>
    </div>

    <div id="page_history" class="tab-pane fade">
        <br>
        <div class="spinner-grow text-muted"></div>
        <div class="spinner-grow text-primary"></div>
        <div class="spinner-grow text-success"></div>
        <div class="spinner-grow text-info"></div>
        <div class="spinner-grow text-warning"></div>
        <div class="spinner-grow text-danger"></div>
        <div class="spinner-grow text-secondary"></div>
        <div class="spinner-grow text-dark"></div>
        <div class="spinner-grow text-light"></div>
    </div>
</div>


{% endblock content%}


{% block javascript %}
<script>
    // to load history of book
    $(document).ready(function () {
        $("#history_tab").click(function () {
            $.ajax({
                url: "{% url 'book-histories' book.pk %}",
                dataType: 'json',
                success: function (returned_data) {
                    $('#history').html(returned_data.histories_html)
                }
            });
        });
        // load pages
        $.ajax({
            url: "{% url 'page-list' book.pk %}",
            dataType: 'json',
            success: function(returned_data){
                $('#pageList').html(returned_data.page_list);
                $('#page-content-tab').html(returned_data.page_tab);
                // add event to page list tabs
                $('#pageList').on('shown.bs.tab', '#page-list-tab > a' ,function(e){
                    // activated page id
                    var activePageId = $(e.target).attr("id");
                    // extract page id from id of tab list
                    activePageId = activePageId.replace('page-list-','');
                    // console.log(activePageId);
                    // ajax to load page content
                    $.ajax({
                        url: "/library/book/page/" + activePageId + "/",
                        dataType: 'json',
                        success: function (returned_data) {
                            $('#page-' + activePageId).html(returned_data.paragraphs);
                        },
                        error: function(xhr, textStatus, errorThrown){
                            console.log('STATUS: '+textStatus+'\nERROR THROWN: '+errorThrown);
                            console.log(xhr);
                        }
                    });
                    // change states of buttons
                    $('#edit-page').prop('disabled', false);
                    $('#delete-page').prop('disabled', false);
                    if ($('#page-list-tab > a:first').hasClass('active') && $('#page-list-tab > a:last').hasClass('active')){
                        // it means here only one page exist
                        $('#up-page').prop('disabled', true);
                        $('#down-page').prop('disabled', true);
                    }
                    else if($('#page-list-tab > a:first').hasClass('active')){
                        $('#up-page').prop('disabled', true);
                        $('#down-page').prop('disabled', false);
                    }
                    else if ($('#page-list-tab > a:last').hasClass('active')){
                        $('#up-page').prop('disabled', false);
                        $('#down-page').prop('disabled', true);
                    }
                    else {
                        $('#up-page').prop('disabled', false);
                        $('#down-page').prop('disabled', false);
                    }
                });
            }
        });
    });



    ////////////////////////
    ////////////////////////
    // find active page list
    function findActivePage(){
        // search for active page id
        var activePageId = $('#page-list-tab > a.active').attr('id');
        // if null put zero in it or clean it from first part and just stay only id
        if (activePageId == null){
            activePageId = '0';
        }
        else
        {
            activePageId = activePageId.replace('page-list-','');
        }
        return activePageId;
    }
    ////////////////////////
    ////////////////////////
    // form
    // cancel button on page form functions
    function pageFormCancel(e){
        // enable buttons
        buttonsState(true);
    }
    // this will be active when form loaded
    function submitHandler(e){
        // it is needed
        e.preventDefault();

        // activePage defaul it  zero
        var activePage = '0';
        // get id of selected page tab
        var activePageId = $('#page-list-tab > a.active').attr('id');
        // if null it means not any page selected
        if (activePageId == null){
            // get last page
            activePageId = $('#page-list-tab > a:last').attr('id');
            // if activePageId is null it means there no page yet for this book, and default value used and it is zero setted before
            // otherwise extract id 
            if (activePageId != null){
                activePage = activePageId.replace('page-list-','');
            }
        }
        else
        {
            activePage = activePageId.replace('page-list-','');
        }


        // add csrf_token to from
        $('#page-form').append('<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">');
        $('#id_preview_page').val(activePage);
        //return;
        $.ajax({
            type: 'POST',
            url: "{% url 'page-create' book.id %}",
            data: $("#page-form").serialize(),
            dataType:'json',
            success: function(returned_data){
                $('#page-content-tab').html(returned_data.page_tab);
                // after updating ready make trigger click for new page
                $('#pageList').html(returned_data.page_list).ready(function(){
                    $('#page-list-' + returned_data.new_page_id).trigger('click');
                });

                // restore list and buttons like cancel button
                buttonsState(true);
            },
            error: function(xhr, textStatus, errorThrown){
                console.log('STATUS: '+textStatus+'\nERROR THROWN: '+errorThrown);
                console.log(xhr);
            }
        })
    }
    ////////////////////////
    ////////////////////////
    // buttons
    // change buttons states
    function buttonsState(state){
        var activePage = findActivePage();
        if(state){
            var activePage = findActivePage();
            // remove class from form tab to hide
            $('#page-0').removeClass('active show');
            // enable buttons
            $('#add-page').prop('disabled', false);
            if(activePage != 0){
                // activate and show it
                $('#page-' + activePage).addClass('active show');
                $('#edit-page').prop('disabled', false);
                $('#delete-page').prop('disabled', false);

                if($('#page-list-tab > a:first').hasClass('active')){
                    $('#down-page').prop('disabled', false);
                }
                else if ($('#page-list-tab > a:last').hasClass('active')){
                    $('#up-page').prop('disabled', false);
                }
                else {
                    $('#up-page').prop('disabled', false);
                    $('#down-page').prop('disabled', false);
                }
            }
            // enabled page list
            $('#page-list-tab').children().attr('data-toggle','list');

        }
        else {
            // activate and show it
            $('#page-0').addClass('active show');
            if(activePage != 0){
                $('#page-' + activePage).removeClass('active show');
            }
            // disabling buttons
            $('#add-page').prop('disabled', true);
            $('#edit-page').prop('disabled', true);
            $('#up-page').prop('disabled', true);
            $('#down-page').prop('disabled', true);
            $('#delete-page').prop('disabled', true);
            // disabled page list
            $('#page-list-tab').children().removeAttr('data-toggle');
            //$('#page-list-tab').children().removeAttr('href');

            $('#page-list-tab').children().prop("onclick", null);

        }

    }

    // add new page
    function addPage() {
        $.ajax({
            url: "{% url 'page-create' book.pk %}",
            dataType: 'json',
            success: function (returned_data) {
                // load form html
                $('#page-0').html(returned_data.form);

                // when load page creation form add event to form
                const form = document.getElementById('page-form');
                form.addEventListener("submit", submitHandler);
                // disable buttons and list
                buttonsState(false);
            },
            error: function(xhr, textStatus, errorThrown){
                console.log('STATUS: '+textStatus+'\nERROR THROWN: '+errorThrown);
                console.log(xhr);
            }
        });
    };

    // edit page
    function editPage(){

    }

    // up page
    function upPage(){

    }

    // down page
    function downPage(){

    }

    // delete page
    function deletePage(){
        
    }




</script>
{% endblock javascript %}


